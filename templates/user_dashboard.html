<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nila Products - Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007BFF;
            --secondary-color: #E83E8C;
            --success-color: #28a745;
            --error-color: #dc3545;
            --warning-color: #ffc107;

            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-color: #212529;
            --text-muted-color: #6c757d;
            --border-color: #dee2e6;
            --sidebar-width: 260px;

            --shadow-sm: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            --shadow-md: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 1rem 3rem rgba(0, 0, 0, 0.175);
            --border-radius-sm: 0.5rem;
            --border-radius-md: 0.8rem;
            --border-radius-lg: 1rem;
            --transition-fast: all 0.2s ease-in-out;
            --transition-smooth: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            position: relative;
            font-smooth: antialiased;
            -webkit-font-smoothing: antialiased;
        }
        
        /* --- CORE LAYOUT --- */
        .page-wrapper {
            display: flex;
        }

        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            background: var(--card-bg);
            border-right: 1px solid var(--border-color);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            z-index: 1100;
        }

        .sidebar .brand {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .sidebar-nav ul { list-style: none; }
        .sidebar-nav li { margin-bottom: 0.5rem; }
        .sidebar-nav a {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.8rem 1rem;
            border-radius: var(--border-radius-sm);
            color: var(--text-muted-color);
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition-fast);
        }
        .sidebar-nav a:hover, .sidebar-nav a.active {
            background-color: rgba(0, 123, 255, 0.1);
            color: var(--primary-color);
        }
        .sidebar-nav a .fa-fw { width: 20px; text-align: center; }

        .main-content-wrapper {
            margin-left: var(--sidebar-width);
            width: calc(100% - var(--sidebar-width));
            display: flex;
            flex-direction: column;
        }
        
        .container {
            width: 95%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem 0;
        }

        /* --- HEADER --- */
        .main-header {
            position: sticky;
            top: 1rem;
            margin: 0 auto 1rem auto;
            width: calc(100% - 2rem);
            max-width: 1400px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(222, 226, 230, 0.5);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-md);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1.5rem;
            padding: 0.8rem 1.5rem;
        }
        
        .search-bar { flex-grow: 1; max-width: 500px; position: relative; }
        .search-input {
            width: 100%; padding: 0.75rem 1rem 0.75rem 2.8rem; background-color: #f1f3f5;
            border: 1px solid var(--border-color); border-radius: 50px; color: var(--text-color);
            font-size: 1rem; transition: var(--transition-fast);
        }
        .search-input:focus {
            outline: none; border-color: var(--primary-color); background-color: var(--card-bg);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
        }
        .search-bar .fa-search { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-muted-color); }

        .header-actions { display: flex; align-items: center; gap: 1rem; }
        .profile-icon-container { position: relative; }
        .profile-icon {
            width: 45px; height: 45px; border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; font-weight: 600; cursor: pointer; user-select: none;
            transition: var(--transition-fast);
        }
        .profile-icon:hover { transform: scale(1.1); box-shadow: var(--shadow-md); }
        .profile-dropdown {
            display: none; position: absolute; top: 120%; right: 0; background: var(--card-bg);
            border: 1px solid var(--border-color); border-radius: var(--border-radius-md); width: 280px;
            padding: 1rem; z-index: 1002; box-shadow: var(--shadow-lg); opacity: 0;
            transform: translateY(10px); transition: var(--transition-smooth);
        }
        .profile-dropdown.active { display: block; opacity: 1; transform: translateY(0); }
        .profile-dropdown-header { text-align: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem; }
        .profile-username { font-weight: 600; font-size: 1.2rem; color: var(--text-color); word-wrap: break-word; }
        .profile-orders { font-size: 0.9rem; color: var(--text-muted-color); }
        
        .action-btn {
            width: 100%; text-align: left; padding: 0.8rem 1rem; margin-top: 0.5rem; border-radius: var(--border-radius-sm);
            border: none; background: #f1f3f5; color: var(--text-color); cursor: pointer;
            font-weight: 500; font-size: 1rem; transition: var(--transition-fast);
        }
        .action-btn:hover { background: #e9ecef; color: var(--primary-color); }
        
        .cart-btn {
            position: relative; background: none; border: none; color: var(--text-muted-color);
            font-size: 1.8rem; cursor: pointer; transition: var(--transition-fast);
        }
        .cart-btn:hover { color: var(--primary-color); }
        .cart-badge {
            position: absolute; top: -5px; right: -10px; background: var(--secondary-color);
            color: white; border-radius: 50%; width: 22px; height: 22px; font-size: 0.8rem;
            font-weight: 700; display: flex; align-items: center; justify-content: center; border: 2px solid var(--card-bg);
        }
        .logout-btn {
            background: transparent; border: 1px solid var(--border-color); color: var(--text-muted-color);
            padding: 0.6rem 1.2rem; border-radius: 50px; cursor: pointer; font-weight: 600; transition: var(--transition-fast);
        }
        .logout-btn:hover { background: var(--error-color); color: white; border-color: var(--error-color); }

        /* --- HERO SECTION --- */
        .hero-section {
            position: relative;
            width: 100%;
            height: 400px;
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            margin-bottom: 2rem;
            background-color: #333; /* Fallback color */
        }
        #hero-video {
            width: 100%; height: 100%; object-fit: cover;
            position: absolute; top: 0; left: 0; z-index: 1;
        }
        .hero-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.4); z-index: 2;
        }
        .hero-content {
            position: relative; z-index: 3; color: white; text-align: center;
            display: flex; flex-direction: column; justify-content: center;
            align-items: center; height: 100%;
        }
        .hero-content h1 { font-size: 3.5rem; font-weight: 700; text-shadow: 2px 2px 8px rgba(0,0,0,0.7); }
        .hero-content p { font-size: 1.25rem; margin-top: 0.5rem; }

        /* --- PRODUCT GRID --- */
        .product-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 2rem; padding: 2rem 0; perspective: 1500px;
        }
        .product-card {
            background: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius-lg);
            overflow: hidden; display: flex; flex-direction: column; transition: var(--transition-smooth); box-shadow: var(--shadow-sm);
        }
        .product-card:hover { transform: translateY(-10px); box-shadow: var(--shadow-lg); }
        .product-image { width: 100%; height: 220px; object-fit: cover; }
        .product-info { padding: 1.25rem; display: flex; flex-direction: column; flex-grow: 1; }
        .product-name { font-size: 1.3rem; font-weight: 600; color: var(--text-color); }
        .product-desc { font-size: 0.9rem; color: var(--text-muted-color); margin: 0.5rem 0 1rem; flex-grow: 1; }
        .product-details { display: flex; justify-content: space-between; align-items: center; }
        .product-price { font-size: 1.5rem; font-weight: 700; color: var(--primary-color); }
        .product-stock {
            font-size: 0.9em;
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            background: rgba(0,0,0,0.05);
            display: inline-block;
            margin: 0.5rem 0;
        }
        .product-stock.out-of-stock {
            color: var(--error-color);
            background: rgba(220, 53, 69, 0.1);
        }
        #no-results-message { text-align: center; font-size: 1.5rem; color: var(--text-muted-color); padding: 4rem; display: none; }
        
        .primary-btn, .secondary-btn {
            width: 100%; padding: 0.9rem; border: none; border-radius: var(--border-radius-sm);
            font-size: 1rem; font-weight: 600; cursor: pointer; transition: var(--transition-fast);
            height: 48px;
            display: flex; align-items: center; justify-content: center;
        }
        .primary-btn {
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); color: white;
            background-size: 200% 100%;
        }
        .primary-btn:hover { background-position: 100% 0; box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3); }
        .primary-btn:disabled, .secondary-btn:disabled { background: #adb5bd; color: #f8f9fa; cursor: not-allowed; transform: none; box-shadow: none; border: none; }

        .secondary-btn {
            background-color: transparent;
            border: 1px solid var(--warning-color);
            color: var(--warning-color);
        }
        .secondary-btn:hover:not(:disabled) {
            background-color: var(--warning-color);
            color: var(--card-bg);
        }
        
        /* --- Styles for Quantity Controller on Product Card --- */
        .product-action-area {
            margin-top: 1.25rem;
            min-height: 48px; /* Match button height to prevent layout shifts */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .quantity-control {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 150px;
            height: 48px;
            border: 1px solid var(--primary-color);
            border-radius: var(--border-radius-sm);
            overflow: hidden;
        }
        .quantity-control-btn {
            background: transparent;
            border: none;
            font-size: 1.5rem;
            font-weight: 500;
            cursor: pointer;
            width: 50px;
            height: 100%;
            color: var(--primary-color);
            transition: var(--transition-fast);
        }
        .quantity-control-btn:disabled {
            color: var(--border-color);
            cursor: not-allowed;
        }
        .quantity-control-btn:hover:not(:disabled) {
            background-color: rgba(0, 123, 255, 0.1);
        }
        .quantity-display {
            font-weight: 600;
            font-size: 1.2rem;
            width: 50px;
            text-align: center;
            color: var(--text-color);
            user-select: none;
        }

        /* --- MODAL STYLES --- */
        .modal {
            display: none; /* Changed from flex to none for JS control */
            position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s ease-in-out;
        }
        .modal.active { 
            display: flex; /* Activate by changing display to flex */
            opacity: 1; 
            pointer-events: auto; 
        }
        .modal-content {
            background: var(--bg-color); border-radius: var(--border-radius-lg); width: 90%;
            max-width: 800px; max-height: 90vh; display: flex; flex-direction: column;
            box-shadow: var(--shadow-lg); transform: scale(0.95); transition: transform 0.3s ease-in-out;
        }
        .modal.active .modal-content { transform: scale(1); }
        .modal-header { padding: 1.5rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 1.8rem; font-weight: 600; }
        .close-modal { font-size: 1.5rem; cursor: pointer; color: var(--text-muted-color); transition: var(--transition-fast); }
        .close-modal:hover { color: var(--error-color); transform: rotate(90deg) scale(1.1); }
        .modal-body { padding: 1.5rem; overflow-y: auto; flex-grow: 1; }
        .modal-footer { padding: 1.5rem; border-top: 1px solid var(--border-color); background: var(--card-bg); border-bottom-left-radius: var(--border-radius-lg); border-bottom-right-radius: var(--border-radius-lg); }
        
        /* --- CART MODAL --- */
        #cart-items-container .empty-cart, #order-history-container .empty-orders { text-align: center; padding: 3rem 0; color: var(--text-muted-color); }
        #cart-items-container .empty-cart i, #order-history-container .empty-orders i { font-size: 3rem; display: block; margin-bottom: 1rem; color: var(--border-color); }
        .cart-item { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }
        .cart-item:last-child { border-bottom: none; }
        .cart-item-img { width: 80px; height: 80px; object-fit: cover; border-radius: var(--border-radius-sm); }
        .cart-item-info { flex-grow: 1; }
        .cart-item-name { font-weight: 600; }
        .cart-item-price { color: var(--text-muted-color); }
        .cart-item-controls { display: flex; align-items: center; gap: 0.75rem; }
        .quantity-btn { background: #e9ecef; border: 1px solid var(--border-color); color: var(--text-color); width: 30px; height: 30px; border-radius: 50%; cursor: pointer; transition: var(--transition-fast); }
        .quantity-btn:hover { background-color: #ced4da; }
        .remove-item-btn { background: none; border: none; color: var(--text-muted-color); font-size: 1.2rem; cursor: pointer; margin-left: 1rem; transition: var(--transition-fast); }
        .remove-item-btn:hover { color: var(--error-color); }
        .cart-total { display: flex; justify-content: space-between; font-size: 1.2rem; font-weight: 600; margin-bottom: 1.5rem; }
        .cart-total .price { color: var(--primary-color); }
        .cart-actions { display: flex; gap: 1rem; }
        .clear-cart-btn { flex-grow: 1; background: transparent; border: 1px solid var(--error-color); color: var(--error-color); }
        .clear-cart-btn:hover { background: var(--error-color); color: white; }
        .checkout-btn { flex-grow: 2; }
        
        /* --- ADDRESS & FORMS --- */
        .address-card {
            background: var(--card-bg); padding: 1rem 1.5rem; border-radius: var(--border-radius-md);
            border: 1px solid var(--border-color); margin-bottom: 1rem;
        }
        .address-card p { margin: 0.25rem 0; color: var(--text-muted-color); }
        .address-card p strong { color: var(--text-color); }
        .address-actions { margin-top: 1rem; display: flex; gap: 0.5rem; }
        .address-actions button {
            background: none; border: 1px solid; padding: 0.4rem 0.8rem;
            border-radius: 5px; cursor: pointer; font-weight: 500; transition: var(--transition-fast);
        }
        .edit-address-btn { border-color: var(--primary-color); color: var(--primary-color); }
        .edit-address-btn:hover { background-color: var(--primary-color); color: white; }
        .delete-address-btn { border-color: var(--error-color); color: var(--error-color); }
        .delete-address-btn:hover { background-color: var(--error-color); color: white; }

        .form-group { margin-bottom: 1.25rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; color: var(--text-muted-color); font-weight: 500; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 0.8rem 1rem; background: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm); color: var(--text-color); font-size: 1rem; transition: var(--transition-fast);
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
             outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
        }
        .form-group input[type="radio"] { display: none; }
        
        /* --- CHECKOUT & RETURN MODAL STYLES --- */
        .checkout-section-title {
            color: var(--primary-color); margin-bottom: 1rem; margin-top: 1.5rem;
            border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; font-weight: 600;
        }
        #selected-address-details {
            margin-top: 1rem;
            background-color: var(--bg-color);
            border: 2px dashed var(--border-color);
        }
        
        #checkout-order-summary .cart-item { font-size: 0.9rem; }
        #checkout-order-summary .cart-item-img { width: 60px; height: 60px; }
        #checkout-order-summary .cart-item-info { display: flex; justify-content: space-between; align-items: center; }
        .item-subtotal { font-weight: 600; color: var(--text-color); }
        #checkout-final-total { font-size: 1.5rem; font-weight: 700; text-align: right; margin-bottom: 1.5rem; }
        #checkout-final-total span { color: var(--success-color); margin-left: 1rem; }
        .payment-section { text-align: right; }
        .payment-logos { margin-top: 1rem; display: flex; justify-content: flex-end; gap: 10px; align-items: center; }
        .payment-logos img { height: 25px; filter: grayscale(1); opacity: 0.7; }
        .payment-logos span { font-size: 0.8rem; color: var(--text-muted-color); }

        /* --- ORDER HISTORY STYLES --- */
        .order-history-controls { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem; padding: 1rem; background: var(--card-bg); border-radius: var(--border-radius-md); align-items: center; }
        .order-history-controls input { padding: 0.6rem; border-radius: var(--border-radius-sm); border: 1px solid var(--border-color); flex-grow: 1; }
        
        .order-summary-card {
            background: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius-md);
            margin-bottom: 1rem; padding: 1.5rem; display: flex; justify-content: space-between;
            align-items: center; flex-wrap: wrap; cursor: pointer; transition: var(--transition-smooth); box-shadow: var(--shadow-sm);
        }
        .order-summary-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); }
        .order-summary-info { display: grid; grid-template-columns: 1.5fr 1fr 1fr; gap: 0.5rem 2rem; font-size: 0.9rem; color: var(--text-muted-color); }
        .order-summary-info strong { color: var(--text-color); font-weight: 500; display: block; margin-bottom: 0.25rem; }
        
        #order-detail-view { display: none; }
        .back-to-orders-btn {
            display: inline-flex; align-items: center; gap: 0.5rem; background: var(--primary-color); color: white;
            border: none; padding: 0.8rem 1.5rem; border-radius: 50px; font-size: 1rem;
            cursor: pointer; margin-bottom: 1.5rem; font-weight: 600; transition: var(--transition-fast);
        }
        .back-to-orders-btn:hover { background: var(--secondary-color); box-shadow: var(--shadow-md); }

        .order-detail-header { display: flex; justify-content: space-between; align-items: flex-start; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); margin-bottom: 1.5rem; }
        .order-detail-ids { font-size: 1.2rem; font-weight: 600; }
        .order-detail-ids .invoice-id { font-size: 0.9rem; color: var(--text-muted-color); font-weight: 400; }
        .order-detail-section { padding: 1.5rem; background: var(--card-bg); border-radius: var(--border-radius-md); margin-bottom: 1.5rem; border: 1px solid var(--border-color); }
        .order-detail-section h4 { color: var(--primary-color); margin-bottom: 0.75rem; font-weight: 600; }
        
        /* FIX for return status text collision */
        .return-status-container p { margin-bottom: 1rem; }

        #request-return-btn { border: 1px solid var(--warning-color); color: var(--warning-color); background: transparent; }
        #request-return-btn:hover { background: var(--warning-color); color: var(--text-color); }
        #request-return-btn:disabled { border-color: var(--border-color); color: var(--text-muted-color); cursor: not-allowed; background: transparent; }
        
        .order-items-list .cart-item-img { width: 50px; height: 50px; }
        .order-footer { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; border-top: 1px solid var(--border-color); padding-top: 1.5rem; margin-top: 1.5rem; }
        .invoice-buttons { display: flex; flex-wrap: wrap; gap: 1rem; }
        .download-invoice-btn {
            background: transparent; border: 1px solid var(--primary-color); color: var(--primary-color);
            padding: 0.6rem 1.2rem; border-radius: 6px; cursor: pointer; font-weight: 600;
            transition: var(--transition-fast); text-decoration: none; font-size: 0.9rem;
        }
        .download-invoice-btn:hover { background: var(--primary-color); color: white; }
        .order-total { font-size: 1.3rem; font-weight: 700; color: var(--success-color); }
        
        .order-status { padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.9rem; font-weight: 600; text-transform: capitalize; text-align: center; }
        .status-delivered { background-color: rgba(40, 167, 69, 0.1); color: var(--success-color); }
        .status-shipped { background-color: rgba(0, 123, 255, 0.1); color: var(--primary-color); }
        .status-out-for-delivery { background-color: rgba(255, 193, 7, 0.15); color: #b98900; }
        .status-return-requested { background-color: rgba(255, 136, 0, 0.15); color: #d97000; }
        .status-returned { background-color: rgba(220, 53, 69, 0.1); color: var(--error-color); }

        /* Custom Radio Buttons for Return Form */
        .radio-group label {
            display: inline-flex; align-items: center; gap: 0.5rem; margin-right: 1rem; padding: 0.75rem 1rem;
            border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); cursor: pointer; transition: var(--transition-fast);
        }
        .radio-group input[type="radio"]:checked + label { background-color: rgba(0, 123, 255, 0.1); border-color: var(--primary-color); color: var(--primary-color); }
        #custom-return-address-form, #custom-return-contact-form { display: none; padding: 1.5rem; border: 1px dashed var(--border-color); margin-top: 1rem; border-radius: var(--border-radius-md); }
        
        /* --- ACCOUNT MODAL STYLES --- */
        .account-detail-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        .account-detail-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .account-detail-section h4 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-weight: 600;
        }
        #account-details-container .address-card {
             margin-bottom:1rem; 
             opacity:0.9;
             border: 1px solid var(--border-color);
        }
        #account-details-container .address-card:last-child {
            margin-bottom: 0;
        }

        @media (max-width: 1200px) {
            .sidebar { transform: translateX(-100%); transition: transform 0.3s ease; }
            .sidebar.active { transform: translateX(0); }
            .main-content-wrapper { margin-left: 0; width: 100%; }
        }

        @media (max-width: 768px) {
            .header-content { flex-wrap: wrap; gap: 1rem; }
            .search-bar { order: 3; width: 100%; max-width: none; }
            .header-actions { order: 2; }
            .order-summary-card { flex-direction: column; align-items: flex-start; gap: 1rem; }
            .order-summary-info { grid-template-columns: 1fr; width: 100%;}
            .order-summary-status { width: 100%; text-align: left; }
        }
    </style>
</head>
<body>

<div class="page-wrapper">
    <aside class="sidebar">
        <div class="brand">NILA</div>
        <nav class="sidebar-nav">
            <ul>
                <li><a href="#" class="active"><i class="fas fa-store fa-fw"></i> Dashboard</a></li>
                <li><a href="#" id="sidebar-orders-link"><i class="fas fa-box fa-fw"></i> My Orders</a></li>
                <li><a href="#" id="sidebar-account-link"><i class="fas fa-user-circle fa-fw"></i> Your Account</a></li>
                <li><a href="#" id="sidebar-shipping-link"><i class="fas fa-truck fa-fw"></i> Shipping Details</a></li>
                <li><a href="#" id="sidebar-support-link"><i class="fas fa-headset fa-fw"></i> Customer Support</a></li>
                <li><a href="#" id="sidebar-careers-link"><i class="fas fa-briefcase fa-fw"></i> Careers</a></li>
            </ul>
        </nav>
    </aside>

    <div class="main-content-wrapper">
        <header class="main-header">
            <div class="container">
                <div class="header-content">
                    <div class="search-bar">
                        <i class="fas fa-search"></i>
                        <input type="text" id="search-input" class="search-input" placeholder="Search for products...">
                    </div>
                    <div class="header-actions">
                        <button id="cart-btn" class="cart-btn">
                            <i class="fas fa-shopping-cart"></i>
                            <span id="cart-badge" class="cart-badge">0</span>
                        </button>
                        <div class="profile-icon-container">
                            <div id="profile-icon" class="profile-icon"></div>
                            <div id="profile-dropdown" class="profile-dropdown">
                                <div class="profile-dropdown-header">
                                    <div id="profile-username" class="profile-username"></div>
                                    <div id="profile-orders" class="profile-orders"></div>
                                </div>
                                <div class="profile-dropdown-actions">
                                    <button id="my-orders-btn" class="action-btn"><i class="fas fa-box" style="margin-right: 10px; width: 20px;"></i>My Orders</button>
                                    <button id="shipping-details-btn" class="action-btn"><i class="fas fa-truck" style="margin-right: 10px; width: 20px;"></i>Shipping Details</button>
                                </div>
                            </div>
                        </div>
                        <button id="logout-btn" class="logout-btn">Logout</button>
                    </div>
                </div>
            </div>
        </header>

        <main class="container">
            <div id="product-grid" class="product-grid">
                </div>
            <div id="no-results-message">No products found matching your search.</div>
        </main>
    </div>
</div>

<div id="cart-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h2 class="modal-title">Shopping Cart</h2>
            <span class="close-modal">&times;</span>
        </div>
        <div id="cart-items-container" class="modal-body"></div>
        <div class="modal-footer">
            <div class="cart-total">
                <span>Total:</span>
                <span id="cart-total-price" class="price">₹0.00</span>
            </div>
            <div class="cart-actions">
                <button id="clear-cart-btn" class="primary-btn clear-cart-btn">Clear Cart</button>
                <button id="checkout-btn" class="primary-btn checkout-btn">Checkout</button>
            </div>
        </div>
    </div>
</div>

<div id="shipping-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h2 class="modal-title">Shipping Addresses</h2>
            <span class="close-modal">&times;</span>
        </div>
        <div id="shipping-address-list" class="modal-body"></div>
        <div class="modal-footer">
            <button id="add-new-address-btn" class="primary-btn">Add New Address</button>
        </div>
    </div>
</div>

<div id="address-form-modal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h2 id="address-form-title" class="modal-title">Add New Address</h2>
            <span class="close-modal">&times;</span>
        </div>
        <div class="modal-body">
            <form id="address-form">
                <div class="form-group"><label for="form-name">Full Name</label><input type="text" id="form-name" required></div>
                <div class="form-group"><label for="form-phone">Phone Number</label><input type="tel" id="form-phone" required></div>
                <div class="form-group"><label for="form-address">Address (Flat, House no, Building)</label><textarea id="form-address" rows="3" required></textarea></div>
                <div class="form-group"><label for="form-city">City</label><input type="text" id="form-city" required></div>
                <div class="form-group"><label for="form-pincode">Pincode</label><input type="text" id="form-pincode" required></div>
                <div class="form-group"><label for="form-state">State</label><input type="text" id="form-state" required></div>
                <div class="form-group"><label for="form-country">Country</label><input type="text" id="form-country" required></div>
                <div class="form-group"><label for="form-organization">Organization Name (Optional)</label><input type="text" id="form-organization"></div>
            </form>
        </div>
        <div class="modal-footer">
            <button id="save-address-btn" type="submit" form="address-form" class="primary-btn">Save Address</button>
        </div>
    </div>
</div>

<div id="checkout-modal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h2 class="modal-title">Checkout</h2>
            <span class="close-modal">&times;</span>
        </div>
        <div class="modal-body">
            <h3 class="checkout-section-title">Select Shipping Address</h3>
            <div id="checkout-address-selector"></div>
            
            <h3 class="checkout-section-title">Order Summary</h3>
            <div id="checkout-order-summary"></div>
        </div>
        <div class="modal-footer">
            <div id="checkout-final-total"></div>
            <div class="payment-section">
                <button id="pay-now-btn" class="primary-btn">Pay Now</button>
                <div class="payment-logos">
                    <span>We Accept:</span>
                    <img src="https://img.icons8.com/color/48/bhim-upi.png" alt="UPI">
                    <img src="https://img.icons8.com/color/48/visa.png" alt="Visa">
                    <img src="https://img.icons8.com/color/48/mastercard.png" alt="Mastercard">
                    <img src="https://img.icons8.com/color/48/rupay.png" alt="Rupay">
                </div>
            </div>
        </div>
    </div>
</div>

<div id="orders-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Your Order History</h2>
            <span class="close-modal">&times;</span>
        </div>
        <div id="order-history-container" class="modal-body"></div>
    </div>
</div>

<div id="return-request-modal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h2 class="modal-title">Request Return</h2>
            <span class="close-modal">&times;</span>
        </div>
        <div class="modal-body">
            <form id="return-request-form">
                <input type="hidden" id="return-order-id">
                
                <div class="form-group">
                    <label for="return-reason">Reason for Return</label>
                    <select id="return-reason" required>
                        <option value="" disabled selected>-- Select a Reason --</option>
                        <option value="damaged">Damaged Product</option>
                        <option value="mismatched">Fake/Mismatched Product</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Video Verification</label>
                    <div style="background: #e9ecef; padding: 1rem; border-radius: var(--border-radius-sm); font-size: 0.9em; color: var(--text-muted-color);">
                        <strong>Guidelines:</strong>
                        <ul style="padding-left: 1.2rem; margin-top: 0.5rem;">
                            <li>Show the original invoice clearly at the start of the video.</li>
                            <li>The video must be continuous, without any pauses or edits.</li>
                            <li>Ensure good lighting; avoid dim or black screens.</li>
                            <li>Clearly show the product's defect or mismatch.</li>
                        </ul>
                    </div>
                    <input type="file" id="return-video-upload" name="videoFile" accept="video/*" style="margin-top: 1rem;" required>
                    <video id="video-preview" width="100%" controls style="display:none; margin-top: 1rem; border-radius: var(--border-radius-sm);"></video>
                </div>

                <h4 class="checkout-section-title">Pickup Address</h4>
                <div class="form-group radio-group">
                    <input type="radio" name="returnAddressType" id="addr-same" value="same" checked>
                    <label for="addr-same">Same as original shipping address</label>
                    <input type="radio" name="returnAddressType" id="addr-custom" value="custom">
                    <label for="addr-custom">Use a custom address</label>
                </div>
                <div id="original-shipping-address-display" class="address-card" style="opacity: 0.8; margin-top: 0.5rem;"></div>
                <div id="custom-return-address-form">
                    <div class="form-group"><label for="return-form-name">Full Name</label><input type="text" id="return-form-name"></div>
                    <div class="form-group"><label for="return-form-phone-addr">Phone Number</label><input type="tel" id="return-form-phone-addr"></div>
                    <div class="form-group"><label for="return-form-address">Address</label><textarea id="return-form-address" rows="2"></textarea></div>
                    <div class="form-group"><label for="return-form-city">City</label><input type="text" id="return-form-city"></div>
                    <div class="form-group"><label for="return-form-pincode">Pincode</label><input type="text" id="return-form-pincode"></div>
                    <div class="form-group"><label for="return-form-state">State</label><input type="text" id="return-form-state"></div>
                    <div class="form-group"><label for="return-form-country">Country</label><input type="text" id="return-form-country"></div>
                </div>
    
                <h4 class="checkout-section-title">Contact Number for Pickup</h4>
                <div class="form-group radio-group">
                    <input type="radio" name="returnContactType" id="contact-same" value="same" checked>
                    <label for="contact-same">Same as shipping contact</label>
                    <input type="radio" name="returnContactType" id="contact-custom" value="custom">
                    <label for="contact-custom">Use a custom number</label>
                </div>
                <div id="custom-return-contact-form">
                     <div class="form-group"><label for="return-form-contact">Custom Phone Number</label><input type="tel" id="return-form-contact"></div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button id="submit-return-request-btn" type="submit" form="return-request-form" class="primary-btn">Submit Request</button>
        </div>
    </div>
</div>

<div id="account-modal" class="modal">
    <div class="modal-content" style="max-width: 650px;">
        <div class="modal-header">
            <h2 class="modal-title">Your Account Details</h2>
            <span class="close-modal">&times;</span>
        </div>
        <div id="account-details-container" class="modal-body">
        </div>
    </div>
</div>

<div id="careers-modal" class="modal">
    <div class="modal-content" style="max-width: 95vw; width: 100%; height: 90vh;">
        <div class="modal-header">
            <h2 class="modal-title">Nila Careers</h2>
            <span class="close-modal">&times;</span>
        </div>
        <div class="modal-body" style="padding: 0; overflow: hidden;">
            <iframe id="careers-frame" src="about:blank" style="width: 100%; height: 100%; border: none;" title="Nila Careers"></iframe>
        </div>
    </div>
</div>

<div id="customer-support-modal" class="modal">
    <div class="modal-content" style="max-width: 95vw; width: 100%; height: 90vh;">
        <div class="modal-header">
            <h2 class="modal-title">Customer Support</h2>
            <span class="close-modal">&times;</span>
        </div>
        <div class="modal-body" style="padding: 0; overflow: hidden;">
            <iframe id="customer-support-frame" src="about:blank" style="width: 100%; height: 100%; border: none;" title="Customer Support"></iframe>
        </div>
    </div>
</div>


<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getDatabase, ref, get, set, push, remove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
    import { getAuth, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBRKgP7yqv86HWj6zFFsQeGg2z6ZP4-1NM",
        authDomain: "nila-products.firebaseapp.com",
        databaseURL: "https://nila-products-default-rtdb.firebaseio.com",
        projectId: "nila-products",
        storageBucket: "nila-products.appspot.com",
        messagingSenderId: "220111835843",
        appId: "1:220111835843:web:1ce377f19be2042a068876",
        measurementId: "G-C2TLHBSSFC"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);
    const auth = getAuth(app);
    const LOGGED_IN_USER_EMAIL = "{{ user_email | safe }}";

    document.addEventListener('DOMContentLoaded', () => {
        // --- Element References ---
        const productGridEl = document.getElementById('product-grid');
        const searchInputEl = document.getElementById('search-input');
        const noResultsEl = document.getElementById('no-results-message');
        const logoutBtn = document.getElementById('logout-btn');
        const cartBtn = document.getElementById('cart-btn');
        const cartModal = document.getElementById('cart-modal');
        const cartBadgeEl = document.getElementById('cart-badge');
        const cartItemsContainerEl = document.getElementById('cart-items-container');
        const cartTotalPriceEl = document.getElementById('cart-total-price');
        const clearCartBtn = document.getElementById('clear-cart-btn');
        const checkoutBtn = document.getElementById('checkout-btn');
        const profileIcon = document.getElementById('profile-icon');
        const profileDropdown = document.getElementById('profile-dropdown');
        const profileUsernameEl = document.getElementById('profile-username');
        const profileOrdersEl = document.getElementById('profile-orders');
        const shippingDetailsBtn = document.getElementById('shipping-details-btn');
        const shippingModal = document.getElementById('shipping-modal');
        const shippingAddressListEl = document.getElementById('shipping-address-list');
        const addNewAddressBtn = document.getElementById('add-new-address-btn');
        const addressFormModal = document.getElementById('address-form-modal');
        const addressForm = document.getElementById('address-form');
        const addressFormTitle = document.getElementById('address-form-title');
        const checkoutModal = document.getElementById('checkout-modal');
        const checkoutAddressSelectorEl = document.getElementById('checkout-address-selector');
        const checkoutOrderSummaryEl = document.getElementById('checkout-order-summary');
        const checkoutFinalTotalEl = document.getElementById('checkout-final-total');
        const payNowBtn = document.getElementById('pay-now-btn');
        const myOrdersBtn = document.getElementById('my-orders-btn');
        const ordersModal = document.getElementById('orders-modal');
        const orderHistoryContainerEl = document.getElementById('order-history-container');
        const returnRequestModal = document.getElementById('return-request-modal');
        const returnRequestForm = document.getElementById('return-request-form');
        const sidebarOrdersLink = document.getElementById('sidebar-orders-link');
        const sidebarAccountLink = document.getElementById('sidebar-account-link');
        const sidebarShippingLink = document.getElementById('sidebar-shipping-link');
        const accountModal = document.getElementById('account-modal');
        const accountDetailsContainer = document.getElementById('account-details-container');
        // New elements for Careers Modal
        const sidebarCareersLink = document.getElementById('sidebar-careers-link');
        const careersModal = document.getElementById('careers-modal');
        const careersFrame = document.getElementById('careers-frame');
        // New elements for Customer Support Modal
        const sidebarSupportLink = document.getElementById('sidebar-support-link');
        const customerSupportModal = document.getElementById('customer-support-modal');
        const customerSupportFrame = document.getElementById('customer-support-frame');

        // --- State Variables ---
        let products = [];
        let cart = [];
        let currentUser = { email: null, name: 'Guest', orders: 0 };
        let fullUserData = null;
        let shippingAddresses = {};
        let editingAddressId = null;
        let allUserOrders = {};
        
        // --- Initialization ---
        const init = async () => {
             const loggedInEmail = LOGGED_IN_USER_EMAIL;
             if (!loggedInEmail || loggedInEmail === "None") {
                 window.location.href = '/login.html'; return;
             }
             try {
                 const token = sessionStorage.getItem('firebaseToken');
                 if (token) {
                     await signInWithCustomToken(auth, token);
                     sessionStorage.removeItem('firebaseToken');
                 } else {
                     console.warn("Firebase token not in session storage.");
                 }
                 await fetchUserData(loggedInEmail);
                 await fetchProducts();
                 await fetchAddresses();
                 updateCartUI();

                 setInterval(fetchCurrentStocks, 10000);
             } catch (error) {
                 console.error("Initialization failed:", error);
                 window.location.href = '/logout';
             }
        };

        const fetchProducts = async () => {
            try {
                const response = await fetch('/get_products');
                const data = await response.json();
                if (data.success) {
                    products = data.products;
                    renderProducts();
                } else {
                    console.error("Failed to fetch products:", data.error);
                    productGridEl.innerHTML = `<p style="color:var(--error-color); text-align:center;">Could not load products.</p>`;
                }
            } catch (error) {
                console.error("Error fetching products:", error);
                productGridEl.innerHTML = `<p style="color:var(--error-color); text-align:center;">Could not load products.</p>`;
            }
        };

        const fetchUserData = async (email) => {
            const safeEmailKey = email.replace(/\./g, '_');
            const userRef = ref(database, 'users/' + safeEmailKey);
            try {
                const snapshot = await get(userRef);
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    fullUserData = data;
                    const orderHistory = data.order_details?.order_history || {};
                    const actualOrderCount = Object.keys(orderHistory).length;
                    currentUser = { email: data.email, name: data.name || 'Valued Customer', orders: actualOrderCount };
                    if (actualOrderCount !== (data.orders || 0)) {
                        await set(ref(database, `users/${safeEmailKey}/orders`), actualOrderCount);
                    }
                    cart = (data.cart_items && Array.isArray(data.cart_items)) ? data.cart_items : [];
                } else {
                    currentUser = { email: email, name: 'New User', orders: 0 };
                    fullUserData = { ...currentUser, order_details: { shipping_address: {} } };
                    cart = [];
                }
                updateUserInfoUI();
            } catch (error) { console.error("Error fetching user data:", error); }
        };

        const updateUserInfoUI = () => {
            if (currentUser.name && currentUser.name.length > 0) {
                profileIcon.textContent = currentUser.name.charAt(0).toUpperCase();
            }
            profileUsernameEl.textContent = currentUser.name;
            profileOrdersEl.textContent = `Total Orders: ${currentUser.orders}`;
        };

        const renderProducts = (filteredProducts = products) => {
            productGridEl.innerHTML = '';
            if (filteredProducts.length === 0 && searchInputEl.value) { 
                noResultsEl.style.display = 'block'; 
                return; 
            }
            noResultsEl.style.display = 'none';
            filteredProducts.forEach(product => {
                const itemInCart = cart.find(item => item.id === product.id);
                const isStockAvailable = typeof product.availableStock === 'number' && product.availableStock >= 0;
                const stock = isStockAvailable ? product.availableStock : 0;
                
                let stockDisplayHtml;
                if (isStockAvailable) {
                    stockDisplayHtml = `<span class="product-stock ${stock <= 0 ? 'out-of-stock' : ''}">In Stock: ${stock}</span>`;
                } else {
                    stockDisplayHtml = `<span class="product-stock out-of-stock">Not Available</span>`;
                }

                let actionButtonHtml;
                if (itemInCart) {
                    actionButtonHtml = `
                        <div class="quantity-control">
                            <button class="quantity-control-btn" data-id="${product.id}" data-change="-1">-</button>
                            <span class="quantity-display">${itemInCart.quantity}</span>
                            <button class="quantity-control-btn" data-id="${product.id}" data-change="1" ${itemInCart.quantity >= stock ? 'disabled' : ''}>+</button>
                        </div>`;
                } else {
                    if (!isStockAvailable || stock <= 0) {
                        const notified = sessionStorage.getItem(`notified_${product.id}`);
                        actionButtonHtml = `
                            <button class="secondary-btn notify-btn" data-id="${product.id}" ${notified ? 'disabled' : ''}>
                                ${notified ? '✓ Notified' : 'Notify When Available'}
                            </button>`;
                    } else {
                        actionButtonHtml = `
                            <button class="primary-btn add-to-cart-btn" data-id="${product.id}">
                                Add to Cart
                            </button>`;
                    }
                }

                const card = document.createElement('div');
                card.className = 'product-card';
                card.dataset.id = product.id;
                card.innerHTML = `
                    <img src="${product.image}" alt="${product.name}" class="product-image">
                    <div class="product-info">
                        <h3 class="product-name">${product.name}</h3>
                        <p class="product-desc">${product.description}</p>
                        <div class="product-details">
                            <span class="product-price">₹${product.price.toLocaleString()}</span>
                            ${stockDisplayHtml}
                        </div>
                        <div class="product-action-area">
                            ${actionButtonHtml}
                        </div>
                    </div>`;
                productGridEl.appendChild(card);
            });
        };
        
        const getProductStock = (productId) => {
            const product = products.find(p => p.id === productId);
            if (product && typeof product.availableStock === 'number' && product.availableStock >= 0) {
                return product.availableStock;
            }
            return 0;
        };

        const addToCart = (productId) => {
            const product = products.find(p => p.id === productId);
            if (!product || getProductStock(productId) <= 0) return;
            const itemInCart = cart.find(item => item.id === productId);
            if(itemInCart) {
                 if (itemInCart.quantity < getProductStock(productId)) {
                    itemInCart.quantity++;
                }
            } else {
                 cart.push({ id: product.id, name: product.name, price: product.price, quantity: 1, image: product.image });
            }
            saveCart();
            updateCartUI();
        };

        const updateQuantity = (productId, change) => {
            const item = cart.find(i => i.id === productId);
            if (!item) return;

            const availableStock = getProductStock(productId);
            const newQuantity = item.quantity + change;

            if (newQuantity <= 0) {
                removeFromCart(productId);
            } else if (newQuantity > availableStock) {
                alert("Not enough stock available!");
                item.quantity = availableStock;
            } else {
                item.quantity = newQuantity;
            }
            
            saveCart();
            updateCartUI();
        };


        const removeFromCart = (productId) => {
            cart = cart.filter(item => item.id !== productId);
            saveCart();
            updateCartUI();
        };

        const clearCart = () => { cart = []; saveCart(); updateCartUI(); };

        const saveCart = async () => {
            if (!currentUser.email) return;
            try {
                await fetch('/update_cart_db', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ user_email: currentUser.email, cart_items: cart }),
                });
            } catch (error) { console.error("Error saving cart:", error); }
        };

        const updateCartUI = () => {
            cartBadgeEl.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
            if (cart.length === 0) {
                cartItemsContainerEl.innerHTML = `<div class="empty-cart"><i class="fas fa-shopping-basket"></i>Your cart is empty.</div>`;
            } else {
                cartItemsContainerEl.innerHTML = cart.map(item => {
                    const availableStock = getProductStock(item.id);
                    return `<div class="cart-item"><img src="${item.image}" alt="${item.name}" class="cart-item-img"><div class="cart-item-info"><div class="cart-item-name">${item.name}</div><div class="cart-item-price">₹${item.price.toLocaleString()}</div></div><div class="cart-item-controls"><button class="quantity-btn" data-id="${item.id}" data-change="-1">-</button><span>${item.quantity}</span><button class="quantity-btn" data-id="${item.id}" data-change="1" ${item.quantity >= availableStock ? 'disabled' : ''}>+</button><button class="remove-item-btn" data-id="${item.id}"><i class="fas fa-trash"></i></button></div></div>`
                }).join('');
            }
            cartTotalPriceEl.textContent = `₹${cart.reduce((sum, item) => sum + (item.price * item.quantity), 0).toLocaleString()}`;
            checkoutBtn.disabled = cart.length === 0;
            const currentSearch = searchInputEl.value.toLowerCase();
            renderProducts(products.filter(p => p.name.toLowerCase().includes(currentSearch)));
        };

        const fetchCurrentStocks = async () => {
            try {
                const response = await fetch('/get_current_stocks');
                const data = await response.json();
                
                if (data.success) {
                    let stockLevelsChanged = false;
                    let cartNeedsUpdate = false;
                    Object.entries(data.stocks).forEach(([productId, stock]) => {
                        const product = products.find(p => p.id === productId);
                        if (product && product.availableStock !== stock) {
                            product.availableStock = stock;
                            stockLevelsChanged = true;
                            const itemInCart = cart.find(item => item.id === productId);
                            if(itemInCart && itemInCart.quantity > stock) {
                                cartNeedsUpdate = true;
                                itemInCart.quantity = stock > 0 ? stock : 0;
                            }
                        }
                    });

                    const originalCartLength = cart.length;
                    cart = cart.filter(item => item.quantity > 0);
                    if(cart.length < originalCartLength) {
                        cartNeedsUpdate = true;
                    }

                    if (stockLevelsChanged) {
                        const currentSearch = searchInputEl.value.toLowerCase();
                        renderProducts(products.filter(p => p.name.toLowerCase().includes(currentSearch)));
                    }
                    if (cartNeedsUpdate) {
                        console.log("Cart was silently updated due to stock changes.");
                        updateCartUI();
                        saveCart();
                    }
                }
            } catch (error) {
                console.error('Error fetching stock updates:', error);
            }
        };

        // --- Addresses, Orders, and other logic ---
        
        const fetchAddresses = async () => {
            const safeEmailKey = currentUser.email.replace(/\./g, '_');
            const addressRef = ref(database, `users/${safeEmailKey}/order_details/shipping_address`);
            try {
                const snapshot = await get(addressRef);
                shippingAddresses = snapshot.exists() ? snapshot.val() : {};
                renderAddresses();
            } catch (error) {
                console.error("Error fetching shipping addresses:", error);
                shippingAddressListEl.innerHTML = `<p style="color:var(--error-color)">Could not load addresses.</p>`;
            }
        };

        const renderAddresses = () => {
            shippingAddressListEl.innerHTML = '';
            const addressIds = Object.keys(shippingAddresses);
            if (addressIds.length === 0) {
                shippingAddressListEl.innerHTML = `<p>You have no saved shipping addresses.</p>`;
            } else {
                addressIds.forEach(id => {
                    const addr = shippingAddresses[id];
                    const card = document.createElement('div');
                    card.className = 'address-card';
                    card.innerHTML = `<p><strong>${addr.name}</strong> ${addr.organization ? `(${addr.organization})` : ''}</p><p>${addr.address}, ${addr.city}, ${addr.state} - ${addr.pincode}</p><p>${addr.country}</p><p>Phone: ${addr.phone}</p><div class="address-actions"><button class="edit-address-btn" data-id="${id}">Edit</button><button class="delete-address-btn" data-id="${id}">Delete</button></div>`;
                    shippingAddressListEl.appendChild(card);
                });
            }
            addNewAddressBtn.disabled = addressIds.length >= 6;
            addNewAddressBtn.textContent = addressIds.length >= 6 ? "Max Addresses Reached" : "Add New Address";
        };

        const saveAddress = async (addressData) => {
            try {
                const safeEmailKey = currentUser.email.replace(/\./g, '_');
                const basePath = `users/${safeEmailKey}/order_details/shipping_address`;
                let addressRef;
                if (editingAddressId) {
                    addressRef = ref(database, `${basePath}/${editingAddressId}`);
                } else {
                    addressRef = push(ref(database, basePath));
                }
                await set(addressRef, addressData);
                addressFormModal.classList.remove('active');
                await fetchAddresses();
            } catch (error) {
                console.error("Error saving address:", error);
                alert("Could not save address. Please try again.");
            }
        };

        const deleteAddress = async (addressId) => {
            if (confirm("Are you sure you want to delete this address?")) {
                try {
                    const safeEmailKey = currentUser.email.replace(/\./g, '_');
                    const specificAddressRef = ref(database, `users/${safeEmailKey}/order_details/shipping_address/${addressId}`);
                    await remove(specificAddressRef);
                    await fetchAddresses();
                } catch (error) {
                    console.error("Error deleting address:", error);
                    alert("Could not delete address.");
                }
            }
        };

        const setupOrderHistoryView = () => {
            if (orderHistoryContainerEl.querySelector('.order-history-controls')) return;
            const orderControlsHtml = `<div class="order-history-controls"><input type="date" id="order-date-filter" title="Filter by date" style="flex-basis: 200px;"><input type="text" id="order-id-search" placeholder="Search by Order ID..."><button id="clear-order-filters" class="primary-btn" style="width: auto; padding: 0.6rem 1rem; font-size: 0.9rem;">Clear</button></div>`;
            orderHistoryContainerEl.innerHTML = `${orderControlsHtml}<div id="order-list-wrapper"></div>`;
            document.getElementById('order-date-filter').addEventListener('change', filterOrders);
            document.getElementById('order-id-search').addEventListener('input', filterOrders);
            document.getElementById('clear-order-filters').addEventListener('click', () => {
                document.getElementById('order-date-filter').value = '';
                document.getElementById('order-id-search').value = '';
                filterOrders();
            });
        };
        
        const fetchAndRenderOrders = async () => {
            const listWrapper = document.getElementById('order-list-wrapper');
            if(listWrapper) listWrapper.innerHTML = '<p>Loading orders...</p>';
            try {
                const safeEmailKey = currentUser.email.replace(/\./g, '_');
                const ordersRef = ref(database, `users/${safeEmailKey}/order_details/order_history`);
                const snapshot = await get(ordersRef);
                allUserOrders = snapshot.exists() ? snapshot.val() : {};
                renderOrderListView(Object.values(allUserOrders));
            } catch (error) {
                console.error("Error fetching order history:", error);
                if(listWrapper) listWrapper.innerHTML = `<p style="color:var(--error-color)">Could not load order history.</p>`;
            }
        };

        const renderOrderListView = (ordersToRender) => {
            const listWrapper = document.getElementById('order-list-wrapper');
            if (!listWrapper) return;
            if (!ordersToRender || ordersToRender.length === 0) {
                let emptyMessage = `<div class="empty-orders"><i class="fas fa-box-open"></i>You have no past orders.</div>`;
                if(Object.keys(allUserOrders).length > 0) {
                   emptyMessage = `<div class="empty-orders"><i class="fas fa-search"></i>No orders match your filters.</div>`;
                }
                listWrapper.innerHTML = emptyMessage;
            } else {
                const sortedOrders = ordersToRender.sort((a, b) => (b.orderDate || 0) - (a.orderDate || 0));
                const listViewHtml = sortedOrders.map(order => {
                    const orderDate = typeof order.orderDate === 'number' ? new Date(order.orderDate).toLocaleDateString('en-GB') : 'N/A';
                    const statusClass = getStatusClass(order.status);
                    return `<div class="order-summary-card" data-order-id="${order.orderId}"><div class="order-summary-info"><div><strong>Order Placed</strong>${orderDate}</div><div><strong>Total</strong>₹${order.totalAmount.toLocaleString()}</div><div><strong>Order #</strong>${order.orderId}</div></div><div class="order-summary-status"><span class="order-status ${statusClass}">${(order.status || '').replace(/-/g, ' ')}</span></div></div>`;
                }).join('');
                listWrapper.innerHTML = `<div id="order-list-view">${listViewHtml}</div>`;
            }
        };

        const filterOrders = () => {
            const dateFilterValue = document.getElementById('order-date-filter').value;
            const searchIdValue = document.getElementById('order-id-search').value.trim().toLowerCase();
            let filtered = Object.values(allUserOrders);
            if (dateFilterValue) {
                const [year, month, day] = dateFilterValue.split('-').map(Number);
                filtered = filtered.filter(order => {
                    if (!order.orderDate) return false;
                    const orderDate = new Date(order.orderDate);
                    return orderDate.getFullYear() === year && (orderDate.getMonth() + 1) === month && orderDate.getDate() === day;
                });
            }
            if (searchIdValue) {
                filtered = filtered.filter(order => order.orderId.toLowerCase().includes(searchIdValue));
            }
            renderOrderListView(filtered);
        };
        
        const renderOrderDetailView = (orderId) => {
            const order = allUserOrders[orderId];
            if (!order) return;
            const listWrapper = document.getElementById('order-list-wrapper');
            if (!listWrapper) return;
            const statusClass = getStatusClass(order.status);
            const addr = order.shippingAddress;
            const shippingAddressHtml = `<div class="order-detail-section"><h4>Shipping Address</h4><p><strong>${addr.name}</strong><br>${addr.address}<br>${addr.city}, ${addr.state} ${addr.pincode}<br>${addr.country}<br>Phone: ${addr.phone}</p></div>`;
            let deliveryInfoHtml = `<div class="order-detail-section"><h4>Delivery Status</h4><p>Current status: <strong>${(order.status || '').replace(/-/g, ' ')}</strong></p></div>`;
            if (order.status === 'Delivered' && order.deliveryDate) {
                deliveryInfoHtml = `<div class="order-detail-section"><h4>Delivery Info</h4><p>Your order was delivered on <strong>${order.deliveryDate}</strong>.</p></div>`;
            }
            let returnSectionHtml = '';
            if (order.status === 'Delivered' && order.deliveryDate) {
                const deliveryDate = new Date(order.deliveryDate.replace(/-/g, ' '));
                const fifteenDaysAgo = new Date();
                fifteenDaysAgo.setDate(fifteenDaysAgo.getDate() - 15);
                if (deliveryDate > fifteenDaysAgo) {
                    returnSectionHtml = `<div class="order-detail-section"><h4>Request a Return</h4><p>This item is eligible for return within 15 days of delivery.</p><button id="request-return-btn" class="primary-btn" data-order-id="${order.orderId}">Request Return</button></div>`;
                } else {
                    returnSectionHtml = `<div class="order-detail-section"><h4>Return Window Closed</h4><p>The 15-day return window for this order has closed.</p></div>`;
                }
            } else if (order.status === 'Return Requested' || order.status === 'Returned') {
                let videoPreviewHtml = (order.returnDetails && order.returnDetails.videoUrl) ? `<a href="${order.returnDetails.videoUrl}" target="_blank" class="download-invoice-btn" style="margin-top: 10px; display: inline-block;">Preview Verification Video</a>` : '';
                returnSectionHtml = `<div class="order-detail-section"><h4>Return Status</h4><div class="return-status-container"><p>Your return request is currently being processed. Status: <strong>${(order.status || '').replace(/-/g, ' ')}</strong></p>${videoPreviewHtml}</div></div>`;
            }
            const itemsHtml = order.items.map(item => `<div class="cart-item"><img src="${item.image}" alt="${item.name}" class="cart-item-img"><div class="cart-item-info"><div class="cart-item-name">${item.name}</div><div class="cart-item-price">${item.quantity} x ₹${item.price.toLocaleString()}</div></div></div>`).join('');
            const invoiceButtonHtml = `<a href="/download_invoice/${order.orderId}" class="download-invoice-btn" target="_blank">Download Tax Invoice</a>`;
            const returnInvoiceButtonHtml = (order.status === 'Returned' && order.returnInvoiceId) ? `<a href="/download_return_invoice/${order.orderId}" class="download-invoice-btn" target="_blank">Download Return Invoice</a>` : '';
            const detailViewHTML = `<div id="order-detail-view"><button class="back-to-orders-btn"><i class="fas fa-arrow-left"></i> Back to All Orders</button><div class="order-detail-header"><div class="order-detail-ids"><div class="order-id">Order #${order.orderId}</div><div class="invoice-id">Invoice #${order.invoiceId || 'N/A'}${order.returnInvoiceId ? ` / Return #${order.returnInvoiceId}`:''}</div></div><span class="order-status ${statusClass}">${(order.status || '').replace(/-/g, ' ')}</span></div>${shippingAddressHtml}<div class="order-detail-section"><h4>Items in this order</h4><div class="order-items-list">${itemsHtml}</div></div>${deliveryInfoHtml}${returnSectionHtml}<div class="order-footer"><div class="invoice-buttons">${invoiceButtonHtml}${returnInvoiceButtonHtml}</div><div class="order-total">Total: ₹${order.totalAmount.toLocaleString()}</div></div></div>`;
            listWrapper.innerHTML = detailViewHTML;
            document.querySelector('#order-detail-view').style.display = 'block';
        };

        const getStatusClass = (status) => {
            if (!status) return '';
            const normalizedStatus = status.toLowerCase().replace(/\s+/g, '-');
            return `status-${normalizedStatus}`;
        };

        const handleCheckout = () => {
            if (cart.length === 0) { alert("Your cart is empty."); return; }
            const addressIds = Object.keys(shippingAddresses);
            if (addressIds.length === 0) {
                alert("Please add a shipping address before checking out.");
                shippingModal.classList.add('active'); return;
            }
            checkoutAddressSelectorEl.innerHTML = '';
            const selectEl = document.createElement('select');
            selectEl.className = 'form-group';
            selectEl.id = 'checkout-address-dropdown';
            addressIds.forEach(id => {
                const addr = shippingAddresses[id];
                const option = document.createElement('option');
                option.value = id;
                option.textContent = `${addr.name} - ${addr.address}, ${addr.city}`;
                selectEl.appendChild(option);
            });
            const detailsDiv = document.createElement('div');
            detailsDiv.id = 'selected-address-details';
            detailsDiv.className = 'address-card';
            checkoutAddressSelectorEl.appendChild(selectEl);
            checkoutAddressSelectorEl.appendChild(detailsDiv);
            const updateAddressDetails = () => {
                const selectedId = selectEl.value;
                if (!selectedId) { detailsDiv.innerHTML = ''; return; }
                const addr = shippingAddresses[selectedId];
                detailsDiv.innerHTML = `<p><strong>${addr.name}</strong></p><p>${addr.address}, ${addr.city}, ${addr.state} - ${addr.pincode}</p><p>Phone: ${addr.phone}</p>`;
            };
            selectEl.addEventListener('change', updateAddressDetails);
            updateAddressDetails();
            checkoutOrderSummaryEl.innerHTML = cart.map(item => `<div class="cart-item"><img src="${item.image}" alt="${item.name}" class="cart-item-img"><div class="cart-item-info"><div><div class="cart-item-name">${item.name}</div><div class="cart-item-price">(${item.quantity} x ₹${item.price.toLocaleString()})</div></div><div class="item-subtotal">₹${(item.quantity * item.price).toLocaleString()}</div></div></div>`).join('');
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            checkoutFinalTotalEl.innerHTML = `Total Payable: <span>₹${total.toLocaleString()}</span>`;
            cartModal.classList.remove('active');
            checkoutModal.classList.add('active');
        };

        const openAccountModal = () => {
            renderAccountDetails();
            accountModal.classList.add('active');
        };

        const renderAccountDetails = () => {
            if (!fullUserData) {
                accountDetailsContainer.innerHTML = '<p>User details not available.</p>';
                return;
            }
            let html = `<div class="account-detail-section"><h4>Personal Information</h4><p><strong>Name:</strong> ${fullUserData.name || 'N/A'}</p><p><strong>Email:</strong> ${fullUserData.email || 'N/A'}</p><p><strong>Phone:</strong> ${fullUserData.phone || 'N/A'}</p><p><strong>Organization:</strong> ${fullUserData.organization || 'N/A'}</p><p><strong>Total Orders:</strong> ${currentUser.orders || 0}</p></div>`;
            html += `<div class="account-detail-section"><h4>Primary Address (from Registration)</h4><div class="address-card" style="border: none; padding: 0; background: transparent; box-shadow: none;"><p><strong>${fullUserData.name || ''}</strong></p><p>${fullUserData.address || 'N/A'}</p><p>${fullUserData.district || ''}, ${fullUserData.state || ''}</p><p>${fullUserData.pincode || ''}</p><p>${fullUserData.country || ''}</p></div></div>`;
            accountDetailsContainer.innerHTML = html;
        };
        
        // --- Event Listeners ---
        productGridEl.addEventListener('click', async (e) => {
            const button = e.target.closest('button');
            if (!button) return; 

            const productId = button.dataset.id;
            if (button.classList.contains('add-to-cart-btn')) {
                addToCart(productId);
            } else if (button.classList.contains('quantity-control-btn')) {
                const change = parseInt(button.dataset.change);
                updateQuantity(productId, change);
            } else if (button.classList.contains('notify-btn')) {
                button.disabled = true;
                button.textContent = '✓ Notified';
                sessionStorage.setItem(`notified_${productId}`, 'true');
                await fetch('/request_stock_notification', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ productId: productId })
                });
            }
        });

        searchInputEl.addEventListener('input', () => renderProducts(products.filter(p => p.name.toLowerCase().includes(searchInputEl.value.toLowerCase()))));
        
        logoutBtn.addEventListener('click', () => window.location.href = '/logout');
        cartBtn.addEventListener('click', () => cartModal.classList.add('active'));
        
        cartItemsContainerEl.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;
            const productId = target.dataset.id; 
            if (target.classList.contains('quantity-btn')) {
                updateQuantity(productId, parseInt(target.dataset.change));
            } else if (target.classList.contains('remove-item-btn')) {
                removeFromCart(productId);
            }
        });

        clearCartBtn.addEventListener('click', clearCart);
        checkoutBtn.addEventListener('click', handleCheckout);
        
        profileIcon.addEventListener('click', () => profileDropdown.classList.toggle('active'));
        document.addEventListener('click', (e) => {
            if (!profileIcon.contains(e.target) && !profileDropdown.contains(e.target)) {
                profileDropdown.classList.remove('active');
            }
        });

        const openOrdersModal = () => { setupOrderHistoryView(); ordersModal.classList.add('active'); profileDropdown.classList.remove('active'); fetchAndRenderOrders(); };
        const openShippingModal = () => { shippingModal.classList.add('active'); profileDropdown.classList.remove('active'); };
        myOrdersBtn.addEventListener('click', openOrdersModal);
        sidebarOrdersLink.addEventListener('click', (e) => { e.preventDefault(); openOrdersModal(); });
        sidebarShippingLink.addEventListener('click', (e) => { e.preventDefault(); openShippingModal(); });
        sidebarAccountLink.addEventListener('click', (e) => { e.preventDefault(); openAccountModal(); });
        
        shippingDetailsBtn.addEventListener('click', openShippingModal);

        orderHistoryContainerEl.addEventListener('click', async (e) => {
            const summaryCard = e.target.closest('.order-summary-card');
            const backButton = e.target.closest('.back-to-orders-btn');
            const returnButton = e.target.closest('#request-return-btn');
            if (summaryCard) { renderOrderDetailView(summaryCard.dataset.orderId); } 
            else if (backButton) { renderOrderListView(Object.values(allUserOrders)); }
            else if (returnButton) {
                const orderId = returnButton.dataset.orderId;
                const orderData = allUserOrders[orderId];
                if (!orderData) return;
                returnRequestForm.reset();
                document.getElementById('return-order-id').value = orderId;
                const addr = orderData.shippingAddress;
                document.getElementById('original-shipping-address-display').innerHTML = `<p><strong>${addr.name}</strong><br>${addr.address}<br>${addr.city}, ${addr.state} ${addr.pincode}<br>Phone: ${addr.phone}</p>`;
                document.getElementById('custom-return-address-form').style.display = 'none';
                document.getElementById('original-shipping-address-display').style.display = 'block';
                document.getElementById('custom-return-contact-form').style.display = 'none';
                document.getElementById('video-preview').style.display = 'none';
                document.getElementById('return-video-upload').value = '';
                returnRequestModal.classList.add('active');
            }
        });

        returnRequestForm.addEventListener('change', (e) => {
            if (e.target.name === 'returnAddressType') {
                const useCustom = e.target.value === 'custom';
                document.getElementById('custom-return-address-form').style.display = useCustom ? 'block' : 'none';
                document.getElementById('original-shipping-address-display').style.display = useCustom ? 'none' : 'block';
            }
            if (e.target.name === 'returnContactType') {
                document.getElementById('custom-return-contact-form').style.display = e.target.value === 'custom' ? 'block' : 'none';
            }
            if (e.target.id === 'return-video-upload') {
                const videoFile = e.target.files[0];
                const videoPreview = document.getElementById('video-preview');
                if (videoFile) {
                    videoPreview.src = URL.createObjectURL(videoFile);
                    videoPreview.style.display = 'block';
                } else {
                    videoPreview.style.display = 'none';
                }
            }
        });

        returnRequestForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submit-return-request-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';
            const formData = new FormData(returnRequestForm);
            const orderId = document.getElementById('return-order-id').value;
            const reason = document.getElementById('return-reason').value;
            const addressType = document.querySelector('input[name="returnAddressType"]:checked').value;
            let customAddress = null;
            if (addressType === 'custom') {
                customAddress = {
                    name: document.getElementById('return-form-name').value, phone: document.getElementById('return-form-phone-addr').value,
                    address: document.getElementById('return-form-address').value, city: document.getElementById('return-form-city').value,
                    pincode: document.getElementById('return-form-pincode').value, state: document.getElementById('return-form-state').value,
                    country: document.getElementById('return-form-country').value, organization: '',
                };
            }
            const contactType = document.querySelector('input[name="returnContactType"]:checked').value;
            let customContact = null;
            if (contactType === 'custom') {
                customContact = document.getElementById('return-form-contact').value;
            }
            formData.append('orderId', orderId);
            formData.append('reason', reason);
            formData.append('addressInfo', JSON.stringify({ type: addressType, customAddress: customAddress }));
            formData.append('contactInfo', JSON.stringify({ type: contactType, customContact: customContact }));
            try {
                const response = await fetch('/request_return', { method: 'POST', body: formData });
                const result = await response.json();
                if (result.success) {
                    alert(result.message);
                    returnRequestModal.classList.remove('active');
                    await fetchAndRenderOrders(); 
                    renderOrderDetailView(orderId);
                } else {
                    alert(`Error: ${result.error}`);
                }
            } catch (err) {
                alert('An error occurred. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Request';
            }
        });

        addNewAddressBtn.addEventListener('click', () => {
            editingAddressId = null; 
            addressForm.reset();
            addressFormTitle.textContent = 'Add New Address';
            addressFormModal.classList.add('active');
        });

        shippingAddressListEl.addEventListener('click', (e) => {
            const target = e.target;
            if (target.tagName !== 'BUTTON' || !target.dataset.id) return;
            const addressId = target.dataset.id;
            if (target.classList.contains('edit-address-btn')) {
                editingAddressId = addressId;
                const addr = shippingAddresses[addressId];
                document.getElementById('form-name').value = addr.name || '';
                document.getElementById('form-phone').value = addr.phone || '';
                document.getElementById('form-address').value = addr.address || '';
                document.getElementById('form-city').value = addr.city || '';
                document.getElementById('form-pincode').value = addr.pincode || '';
                document.getElementById('form-state').value = addr.state || '';
                document.getElementById('form-country').value = addr.country || '';
                document.getElementById('form-organization').value = addr.organization || '';
                addressFormTitle.textContent = 'Edit Address';
                addressFormModal.classList.add('active');
            } else if (target.classList.contains('delete-address-btn')) {
                deleteAddress(addressId);
            }
        });

        addressForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const addressData = {
                name: document.getElementById('form-name').value, phone: document.getElementById('form-phone').value,
                address: document.getElementById('form-address').value, city: document.getElementById('form-city').value,
                pincode: document.getElementById('form-pincode').value, state: document.getElementById('form-state').value,
                country: document.getElementById('form-country').value, organization: document.getElementById('form-organization').value,
            };
            saveAddress(addressData);
        });

        payNowBtn.addEventListener('click', async () => {
            const selectedAddressDropdown = document.getElementById('checkout-address-dropdown');
            if (!selectedAddressDropdown || !selectedAddressDropdown.value) {
                alert("Please select a shipping address.");
                return;
            }
            const selectedAddressId = selectedAddressDropdown.value;
            payNowBtn.disabled = true;
            payNowBtn.textContent = 'Processing...';
            try {
                const response = await fetch('/place_order', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ address_id: selectedAddressId }),
                });
                const result = await response.json();
                
                if (response.status === 409 && result.cart_updated) {
                    console.error("Order failed due to stock changes:", result.error);
                    alert(result.error); // Show the detailed error message
                    cart = result.updated_cart;
                    await saveCart();
                    updateCartUI();
                    checkoutModal.classList.remove('active');
                    cartModal.classList.add('active');
                } else if (result.success) {
                    clearCart();
                    checkoutModal.classList.remove('active');
                    alert(`Your order #${result.orderId} (Invoice #${result.invoiceId}) has been placed successfully! 🥳`);
                    await fetchUserData(currentUser.email);
                    await fetchProducts();
                } else {
                    alert(`Order failed: ${result.error || 'An unknown error occurred.'}`);
                }
            } catch (error) {
                console.error("Error placing order:", error);
                alert("Could not connect to the server to place your order.");
            } finally {
                payNowBtn.disabled = false;
                payNowBtn.textContent = 'Pay Now';
            }
        });
        
        // Careers Modal Logic
        sidebarCareersLink.addEventListener('click', (e) => {
            e.preventDefault();
            careersFrame.src = 'nila_careers.html';
            careersModal.classList.add('active');
        });

        // Customer Support Modal Logic
        sidebarSupportLink.addEventListener('click', (e) => {
            e.preventDefault();
            customerSupportFrame.src = 'customer_support.html';
            customerSupportModal.classList.add('active');
        });

        // Universal modal close logic
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal || e.target.classList.contains('close-modal')) {
                    modal.classList.remove('active');
                }
            });
        });

        init();
    });
</script>

</body>
</html> 